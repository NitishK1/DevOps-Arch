# Azure DevOps CI/CD Pipeline for ProjectX Order Management System
# This pipeline implements Continuous Integration and Continuous Deployment
# with staging and production environments

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - app/*
      - pipelines/*

variables:
  # Build Configuration
  buildConfiguration: "Release"
  nodeVersion: "18.x"

  # Azure Configuration (set in Azure DevOps Library)
  # - azureSubscription
  # - resourceGroupName
  # - stagingWebAppName
  # - productionWebAppName

stages:
  # ====================================
  # STAGE 1: BUILD & TEST (CI)
  # ====================================
  - stage: Build
    displayName: "Build and Test"
    jobs:
      - job: BuildJob
        displayName: "Build Application"
        pool:
          vmImage: "ubuntu-latest"

        steps:
          - task: NodeTool@0
            displayName: "Install Node.js"
            inputs:
              versionSpec: $(nodeVersion)

          - script: |
              cd app
              npm ci
            displayName: "Install Dependencies"

          - script: |
              cd app
              npm run lint || echo "Linting completed with warnings"
            displayName: "Run Linting"
            continueOnError: true

          - script: |
              cd app
              npm test -- --coverage --passWithNoTests
            displayName: "Run Unit Tests"

          - task: PublishTestResults@2
            displayName: "Publish Test Results"
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: "JUnit"
              testResultsFiles: "**/test-results.xml"
              failTaskOnFailedTests: true

          - task: PublishCodeCoverageResults@1
            displayName: "Publish Code Coverage"
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: "Cobertura"
              summaryFileLocation: "$(System.DefaultWorkingDirectory)/**/coverage/cobertura-coverage.xml"

          - script: |
              cd app
              npm run build
            displayName: "Build Application"

          - task: ArchiveFiles@2
            displayName: "Archive Application"
            inputs:
              rootFolderOrFile: "$(System.DefaultWorkingDirectory)/app"
              includeRootFolder: false
              archiveType: "zip"
              archiveFile: "$(Build.ArtifactStagingDirectory)/projectx-$(Build.BuildId).zip"
              replaceExistingArchive: true

          - task: PublishBuildArtifacts@1
            displayName: "Publish Build Artifacts"
            inputs:
              PathtoPublish: "$(Build.ArtifactStagingDirectory)"
              ArtifactName: "drop"
              publishLocation: "Container"

  # ====================================
  # STAGE 2: DEPLOY TO STAGING
  # ====================================
  - stage: DeployStaging
    displayName: "Deploy to Staging"
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

    jobs:
      - deployment: DeployToStaging
        displayName: "Deploy to Staging Environment"
        environment: "ProjectX-Staging"
        pool:
          vmImage: "ubuntu-latest"

        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@1
                  displayName: "Download Artifacts"
                  inputs:
                    buildType: "current"
                    downloadType: "single"
                    artifactName: "drop"
                    downloadPath: "$(System.ArtifactsDirectory)"

                - task: AzureWebApp@1
                  displayName: "Deploy to Azure Web App (Staging)"
                  inputs:
                    azureSubscription: "$(azureSubscription)"
                    appType: "webAppLinux"
                    appName: "$(stagingWebAppName)"
                    package: "$(System.ArtifactsDirectory)/drop/projectx-$(Build.BuildId).zip"
                    runtimeStack: "NODE|18-lts"
                    startUpCommand: "npm start"

                - script: |
                    echo "Waiting for staging deployment to stabilize..."
                    sleep 30
                  displayName: "Wait for Deployment"

                - script: |
                    STAGING_URL="https://$(stagingWebAppName).azurewebsites.net"
                    echo "Testing staging deployment at: $STAGING_URL"

                    RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $STAGING_URL/api/health)

                    if [ $RESPONSE -eq 200 ]; then
                      echo "âœ“ Staging health check passed!"
                    else
                      echo "âœ— Staging health check failed with status: $RESPONSE"
                      exit 1
                    fi
                  displayName: "Smoke Test - Staging"

                - script: |
                    echo "======================================"
                    echo "Staging Deployment Successful!"
                    echo "URL: https://$(stagingWebAppName).azurewebsites.net"
                    echo "======================================"
                  displayName: "Display Staging URL"

  # ====================================
  # STAGE 3: DEPLOY TO PRODUCTION
  # ====================================
  - stage: DeployProduction
    displayName: "Deploy to Production"
    dependsOn: DeployStaging
    condition: succeeded()

    jobs:
      - deployment: DeployToProduction
        displayName: "Deploy to Production Environment"
        environment: "ProjectX-Production"
        pool:
          vmImage: "ubuntu-latest"

        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@1
                  displayName: "Download Artifacts"
                  inputs:
                    buildType: "current"
                    downloadType: "single"
                    artifactName: "drop"
                    downloadPath: "$(System.ArtifactsDirectory)"

                - task: AzureWebApp@1
                  displayName: "Deploy to Azure Web App (Production)"
                  inputs:
                    azureSubscription: "$(azureSubscription)"
                    appType: "webAppLinux"
                    appName: "$(productionWebAppName)"
                    package: "$(System.ArtifactsDirectory)/drop/projectx-$(Build.BuildId).zip"
                    runtimeStack: "NODE|18-lts"
                    startUpCommand: "npm start"
                    appSettings: |
                      -NODE_ENV production
                      -PORT 8080

                - script: |
                    echo "Waiting for production deployment to stabilize..."
                    sleep 30
                  displayName: "Wait for Deployment"

                - script: |
                    PROD_URL="https://$(productionWebAppName).azurewebsites.net"
                    echo "Testing production deployment at: $PROD_URL"

                    RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $PROD_URL/api/health)

                    if [ $RESPONSE -eq 200 ]; then
                      echo "âœ“ Production health check passed!"
                    else
                      echo "âœ— Production health check failed with status: $RESPONSE"
                      exit 1
                    fi
                  displayName: "Smoke Test - Production"

                - script: |
                    echo "======================================"
                    echo "ðŸŽ‰ Production Deployment Successful!"
                    echo "URL: https://$(productionWebAppName).azurewebsites.net"
                    echo "Build: $(Build.BuildId)"
                    echo "======================================"
                  displayName: "Display Production URL"

                - script: |
                    # Send notification (placeholder - configure with your notification service)
                    echo "Sending deployment notification..."
                    echo "Deployment completed successfully to production"
                  displayName: "Send Notification"
